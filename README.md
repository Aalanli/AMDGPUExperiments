# Sources

Compile on local machine without AMD gpu
[source](https://sep5.readthedocs.io/en/latest/Installation_Guide/Installation-Guide.html)
```bash
wget -qO - http://repo.radeon.com/rocm/apt/debian/rocm.gpg.key | sudo apt-key add -
echo 'deb [arch=amd64] http://repo.radeon.com/rocm/apt/debian/ xenial main' | sudo tee /etc/apt/sources.list.d/rocm.list

sudo apt update
sudo apt install rocm-dev
```

print configuration
```bash
hipconfig
```

compile for nvidia
```bash
export HIP_PLATFORM=nvidia
hipcc test.cpp ...
```

## Matrix Instructions
[AMD Lab notes](https://gpuopen.com/learn/amd-lab-notes/amd-lab-notes-matrix-cores-readme/)
[Matrix Instruction Calculator](https://github.com/RadeonOpenCompute/amd_matrix_instruction_calculator)
> $ ./matrix_calculator.py --architecture cdna2 --instruction v_mfma_f32_16x16x16f16 --register-layout --D-matrix
> d = __builtin_amdgcn_mfma_CDFmt_MxNxKABFmt (a, b, c, cbsz, abid, blgp)

## Profiler
https://gpuopen.com/learn/amd-lab-notes/amd-lab-notes-profilers-readme/

- Omnitrace => NsightSystems
- Omniperf => NsightCompute
  - https://amdresearch.github.io/omniperf/installation.html

| instruction            | blocks | regs per warp (a/b) | regs per warp (c/d) | CBSZ/ABID | BLGP  |
| ---------------------  | ------ | ------------------- | ------------------- | --------- | ----- |
| v_mfma_f32_32x32x1f32  | 2      | 1                   | 32                  | true      | true  |
| v_mfma_f32_16x16x1f32  | 4      | 1                   | 16                  | true      | true  |
| v_mfma_f32_4x4x1f32    | 16     | 1                   | 4                   | true      | true  |
| v_mfma_f32_32x32x2f32  | 1      | 1                   | 16                  | false     | true  |
| v_mfma_f32_16x16x4f32  | 1      | 1                   | 4                   | false     | true  |
| v_mfma_f32_32x32x4f16  | 2      | 2                   | 32                  | true      | true  |
| v_mfma_f32_16x16x4f16  | 4      | 2                   | 16                  | true      | true  |
| v_mfma_f32_4x4x4f16    | 16     | 2                   | 4                   | true      | true  |
| v_mfma_f32_32x32x8f16  | 1      | 2                   | 16                  | false     | true  |
| v_mfma_f32_16x16x16f16 | 1      | 2                   | 4                   | false     | true  |

### v_mfma_f32_16x16x16f16
```
Architecture: CDNA2
Instruction: V_MFMA_F32_16X16X16F16
Block 0
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
|   A[M][K] | 0             | 1              | 2             | 3              | 4             | 5              | 6             | 7              | 8             | 9              | 10            | 11             | 12            | 13             | 14            | 15             |
+===========+===============+================+===============+================+===============+================+===============+================+===============+================+===============+================+===============+================+===============+================+
|         0 | v0{0}.[15:0]  | v0{0}.[31:16]  | v1{0}.[15:0]  | v1{0}.[31:16]  | v0{16}.[15:0] | v0{16}.[31:16] | v1{16}.[15:0] | v1{16}.[31:16] | v0{32}.[15:0] | v0{32}.[31:16] | v1{32}.[15:0] | v1{32}.[31:16] | v0{48}.[15:0] | v0{48}.[31:16] | v1{48}.[15:0] | v1{48}.[31:16] |
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
|         1 | v0{1}.[15:0]  | v0{1}.[31:16]  | v1{1}.[15:0]  | v1{1}.[31:16]  | v0{17}.[15:0] | v0{17}.[31:16] | v1{17}.[15:0] | v1{17}.[31:16] | v0{33}.[15:0] | v0{33}.[31:16] | v1{33}.[15:0] | v1{33}.[31:16] | v0{49}.[15:0] | v0{49}.[31:16] | v1{49}.[15:0] | v1{49}.[31:16] |
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
|         2 | v0{2}.[15:0]  | v0{2}.[31:16]  | v1{2}.[15:0]  | v1{2}.[31:16]  | v0{18}.[15:0] | v0{18}.[31:16] | v1{18}.[15:0] | v1{18}.[31:16] | v0{34}.[15:0] | v0{34}.[31:16] | v1{34}.[15:0] | v1{34}.[31:16] | v0{50}.[15:0] | v0{50}.[31:16] | v1{50}.[15:0] | v1{50}.[31:16] |
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
|         3 | v0{3}.[15:0]  | v0{3}.[31:16]  | v1{3}.[15:0]  | v1{3}.[31:16]  | v0{19}.[15:0] | v0{19}.[31:16] | v1{19}.[15:0] | v1{19}.[31:16] | v0{35}.[15:0] | v0{35}.[31:16] | v1{35}.[15:0] | v1{35}.[31:16] | v0{51}.[15:0] | v0{51}.[31:16] | v1{51}.[15:0] | v1{51}.[31:16] |
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
|         4 | v0{4}.[15:0]  | v0{4}.[31:16]  | v1{4}.[15:0]  | v1{4}.[31:16]  | v0{20}.[15:0] | v0{20}.[31:16] | v1{20}.[15:0] | v1{20}.[31:16] | v0{36}.[15:0] | v0{36}.[31:16] | v1{36}.[15:0] | v1{36}.[31:16] | v0{52}.[15:0] | v0{52}.[31:16] | v1{52}.[15:0] | v1{52}.[31:16] |
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
|         5 | v0{5}.[15:0]  | v0{5}.[31:16]  | v1{5}.[15:0]  | v1{5}.[31:16]  | v0{21}.[15:0] | v0{21}.[31:16] | v1{21}.[15:0] | v1{21}.[31:16] | v0{37}.[15:0] | v0{37}.[31:16] | v1{37}.[15:0] | v1{37}.[31:16] | v0{53}.[15:0] | v0{53}.[31:16] | v1{53}.[15:0] | v1{53}.[31:16] |
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
|         6 | v0{6}.[15:0]  | v0{6}.[31:16]  | v1{6}.[15:0]  | v1{6}.[31:16]  | v0{22}.[15:0] | v0{22}.[31:16] | v1{22}.[15:0] | v1{22}.[31:16] | v0{38}.[15:0] | v0{38}.[31:16] | v1{38}.[15:0] | v1{38}.[31:16] | v0{54}.[15:0] | v0{54}.[31:16] | v1{54}.[15:0] | v1{54}.[31:16] |
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
|         7 | v0{7}.[15:0]  | v0{7}.[31:16]  | v1{7}.[15:0]  | v1{7}.[31:16]  | v0{23}.[15:0] | v0{23}.[31:16] | v1{23}.[15:0] | v1{23}.[31:16] | v0{39}.[15:0] | v0{39}.[31:16] | v1{39}.[15:0] | v1{39}.[31:16] | v0{55}.[15:0] | v0{55}.[31:16] | v1{55}.[15:0] | v1{55}.[31:16] |
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
|         8 | v0{8}.[15:0]  | v0{8}.[31:16]  | v1{8}.[15:0]  | v1{8}.[31:16]  | v0{24}.[15:0] | v0{24}.[31:16] | v1{24}.[15:0] | v1{24}.[31:16] | v0{40}.[15:0] | v0{40}.[31:16] | v1{40}.[15:0] | v1{40}.[31:16] | v0{56}.[15:0] | v0{56}.[31:16] | v1{56}.[15:0] | v1{56}.[31:16] |
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
|         9 | v0{9}.[15:0]  | v0{9}.[31:16]  | v1{9}.[15:0]  | v1{9}.[31:16]  | v0{25}.[15:0] | v0{25}.[31:16] | v1{25}.[15:0] | v1{25}.[31:16] | v0{41}.[15:0] | v0{41}.[31:16] | v1{41}.[15:0] | v1{41}.[31:16] | v0{57}.[15:0] | v0{57}.[31:16] | v1{57}.[15:0] | v1{57}.[31:16] |
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
|        10 | v0{10}.[15:0] | v0{10}.[31:16] | v1{10}.[15:0] | v1{10}.[31:16] | v0{26}.[15:0] | v0{26}.[31:16] | v1{26}.[15:0] | v1{26}.[31:16] | v0{42}.[15:0] | v0{42}.[31:16] | v1{42}.[15:0] | v1{42}.[31:16] | v0{58}.[15:0] | v0{58}.[31:16] | v1{58}.[15:0] | v1{58}.[31:16] |
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
|        11 | v0{11}.[15:0] | v0{11}.[31:16] | v1{11}.[15:0] | v1{11}.[31:16] | v0{27}.[15:0] | v0{27}.[31:16] | v1{27}.[15:0] | v1{27}.[31:16] | v0{43}.[15:0] | v0{43}.[31:16] | v1{43}.[15:0] | v1{43}.[31:16] | v0{59}.[15:0] | v0{59}.[31:16] | v1{59}.[15:0] | v1{59}.[31:16] |
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
|        12 | v0{12}.[15:0] | v0{12}.[31:16] | v1{12}.[15:0] | v1{12}.[31:16] | v0{28}.[15:0] | v0{28}.[31:16] | v1{28}.[15:0] | v1{28}.[31:16] | v0{44}.[15:0] | v0{44}.[31:16] | v1{44}.[15:0] | v1{44}.[31:16] | v0{60}.[15:0] | v0{60}.[31:16] | v1{60}.[15:0] | v1{60}.[31:16] |
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
|        13 | v0{13}.[15:0] | v0{13}.[31:16] | v1{13}.[15:0] | v1{13}.[31:16] | v0{29}.[15:0] | v0{29}.[31:16] | v1{29}.[15:0] | v1{29}.[31:16] | v0{45}.[15:0] | v0{45}.[31:16] | v1{45}.[15:0] | v1{45}.[31:16] | v0{61}.[15:0] | v0{61}.[31:16] | v1{61}.[15:0] | v1{61}.[31:16] |
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
|        14 | v0{14}.[15:0] | v0{14}.[31:16] | v1{14}.[15:0] | v1{14}.[31:16] | v0{30}.[15:0] | v0{30}.[31:16] | v1{30}.[15:0] | v1{30}.[31:16] | v0{46}.[15:0] | v0{46}.[31:16] | v1{46}.[15:0] | v1{46}.[31:16] | v0{62}.[15:0] | v0{62}.[31:16] | v1{62}.[15:0] | v1{62}.[31:16] |
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
|        15 | v0{15}.[15:0] | v0{15}.[31:16] | v1{15}.[15:0] | v1{15}.[31:16] | v0{31}.[15:0] | v0{31}.[31:16] | v1{31}.[15:0] | v1{31}.[31:16] | v0{47}.[15:0] | v0{47}.[31:16] | v1{47}.[15:0] | v1{47}.[31:16] | v0{63}.[15:0] | v0{63}.[31:16] | v1{63}.[15:0] | v1{63}.[31:16] |
+-----------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+---------------+----------------+
```

```
Architecture: CDNA2
Instruction: V_MFMA_F32_16X16X16F16
Block 0
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
|   B[K][N] | 0              | 1              | 2              | 3              | 4              | 5              | 6              | 7              | 8              | 9              | 10             | 11             | 12             | 13             | 14             | 15             |
+===========+================+================+================+================+================+================+================+================+================+================+================+================+================+================+================+================+
|         0 | v0{0}.[15:0]   | v0{1}.[15:0]   | v0{2}.[15:0]   | v0{3}.[15:0]   | v0{4}.[15:0]   | v0{5}.[15:0]   | v0{6}.[15:0]   | v0{7}.[15:0]   | v0{8}.[15:0]   | v0{9}.[15:0]   | v0{10}.[15:0]  | v0{11}.[15:0]  | v0{12}.[15:0]  | v0{13}.[15:0]  | v0{14}.[15:0]  | v0{15}.[15:0]  |
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
|         1 | v0{0}.[31:16]  | v0{1}.[31:16]  | v0{2}.[31:16]  | v0{3}.[31:16]  | v0{4}.[31:16]  | v0{5}.[31:16]  | v0{6}.[31:16]  | v0{7}.[31:16]  | v0{8}.[31:16]  | v0{9}.[31:16]  | v0{10}.[31:16] | v0{11}.[31:16] | v0{12}.[31:16] | v0{13}.[31:16] | v0{14}.[31:16] | v0{15}.[31:16] |
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
|         2 | v1{0}.[15:0]   | v1{1}.[15:0]   | v1{2}.[15:0]   | v1{3}.[15:0]   | v1{4}.[15:0]   | v1{5}.[15:0]   | v1{6}.[15:0]   | v1{7}.[15:0]   | v1{8}.[15:0]   | v1{9}.[15:0]   | v1{10}.[15:0]  | v1{11}.[15:0]  | v1{12}.[15:0]  | v1{13}.[15:0]  | v1{14}.[15:0]  | v1{15}.[15:0]  |
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
|         3 | v1{0}.[31:16]  | v1{1}.[31:16]  | v1{2}.[31:16]  | v1{3}.[31:16]  | v1{4}.[31:16]  | v1{5}.[31:16]  | v1{6}.[31:16]  | v1{7}.[31:16]  | v1{8}.[31:16]  | v1{9}.[31:16]  | v1{10}.[31:16] | v1{11}.[31:16] | v1{12}.[31:16] | v1{13}.[31:16] | v1{14}.[31:16] | v1{15}.[31:16] |
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
|         4 | v0{16}.[15:0]  | v0{17}.[15:0]  | v0{18}.[15:0]  | v0{19}.[15:0]  | v0{20}.[15:0]  | v0{21}.[15:0]  | v0{22}.[15:0]  | v0{23}.[15:0]  | v0{24}.[15:0]  | v0{25}.[15:0]  | v0{26}.[15:0]  | v0{27}.[15:0]  | v0{28}.[15:0]  | v0{29}.[15:0]  | v0{30}.[15:0]  | v0{31}.[15:0]  |
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
|         5 | v0{16}.[31:16] | v0{17}.[31:16] | v0{18}.[31:16] | v0{19}.[31:16] | v0{20}.[31:16] | v0{21}.[31:16] | v0{22}.[31:16] | v0{23}.[31:16] | v0{24}.[31:16] | v0{25}.[31:16] | v0{26}.[31:16] | v0{27}.[31:16] | v0{28}.[31:16] | v0{29}.[31:16] | v0{30}.[31:16] | v0{31}.[31:16] |
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
|         6 | v1{16}.[15:0]  | v1{17}.[15:0]  | v1{18}.[15:0]  | v1{19}.[15:0]  | v1{20}.[15:0]  | v1{21}.[15:0]  | v1{22}.[15:0]  | v1{23}.[15:0]  | v1{24}.[15:0]  | v1{25}.[15:0]  | v1{26}.[15:0]  | v1{27}.[15:0]  | v1{28}.[15:0]  | v1{29}.[15:0]  | v1{30}.[15:0]  | v1{31}.[15:0]  |
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
|         7 | v1{16}.[31:16] | v1{17}.[31:16] | v1{18}.[31:16] | v1{19}.[31:16] | v1{20}.[31:16] | v1{21}.[31:16] | v1{22}.[31:16] | v1{23}.[31:16] | v1{24}.[31:16] | v1{25}.[31:16] | v1{26}.[31:16] | v1{27}.[31:16] | v1{28}.[31:16] | v1{29}.[31:16] | v1{30}.[31:16] | v1{31}.[31:16] |
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
|         8 | v0{32}.[15:0]  | v0{33}.[15:0]  | v0{34}.[15:0]  | v0{35}.[15:0]  | v0{36}.[15:0]  | v0{37}.[15:0]  | v0{38}.[15:0]  | v0{39}.[15:0]  | v0{40}.[15:0]  | v0{41}.[15:0]  | v0{42}.[15:0]  | v0{43}.[15:0]  | v0{44}.[15:0]  | v0{45}.[15:0]  | v0{46}.[15:0]  | v0{47}.[15:0]  |
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
|         9 | v0{32}.[31:16] | v0{33}.[31:16] | v0{34}.[31:16] | v0{35}.[31:16] | v0{36}.[31:16] | v0{37}.[31:16] | v0{38}.[31:16] | v0{39}.[31:16] | v0{40}.[31:16] | v0{41}.[31:16] | v0{42}.[31:16] | v0{43}.[31:16] | v0{44}.[31:16] | v0{45}.[31:16] | v0{46}.[31:16] | v0{47}.[31:16] |
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
|        10 | v1{32}.[15:0]  | v1{33}.[15:0]  | v1{34}.[15:0]  | v1{35}.[15:0]  | v1{36}.[15:0]  | v1{37}.[15:0]  | v1{38}.[15:0]  | v1{39}.[15:0]  | v1{40}.[15:0]  | v1{41}.[15:0]  | v1{42}.[15:0]  | v1{43}.[15:0]  | v1{44}.[15:0]  | v1{45}.[15:0]  | v1{46}.[15:0]  | v1{47}.[15:0]  |
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
|        11 | v1{32}.[31:16] | v1{33}.[31:16] | v1{34}.[31:16] | v1{35}.[31:16] | v1{36}.[31:16] | v1{37}.[31:16] | v1{38}.[31:16] | v1{39}.[31:16] | v1{40}.[31:16] | v1{41}.[31:16] | v1{42}.[31:16] | v1{43}.[31:16] | v1{44}.[31:16] | v1{45}.[31:16] | v1{46}.[31:16] | v1{47}.[31:16] |
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
|        12 | v0{48}.[15:0]  | v0{49}.[15:0]  | v0{50}.[15:0]  | v0{51}.[15:0]  | v0{52}.[15:0]  | v0{53}.[15:0]  | v0{54}.[15:0]  | v0{55}.[15:0]  | v0{56}.[15:0]  | v0{57}.[15:0]  | v0{58}.[15:0]  | v0{59}.[15:0]  | v0{60}.[15:0]  | v0{61}.[15:0]  | v0{62}.[15:0]  | v0{63}.[15:0]  |
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
|        13 | v0{48}.[31:16] | v0{49}.[31:16] | v0{50}.[31:16] | v0{51}.[31:16] | v0{52}.[31:16] | v0{53}.[31:16] | v0{54}.[31:16] | v0{55}.[31:16] | v0{56}.[31:16] | v0{57}.[31:16] | v0{58}.[31:16] | v0{59}.[31:16] | v0{60}.[31:16] | v0{61}.[31:16] | v0{62}.[31:16] | v0{63}.[31:16] |
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
|        14 | v1{48}.[15:0]  | v1{49}.[15:0]  | v1{50}.[15:0]  | v1{51}.[15:0]  | v1{52}.[15:0]  | v1{53}.[15:0]  | v1{54}.[15:0]  | v1{55}.[15:0]  | v1{56}.[15:0]  | v1{57}.[15:0]  | v1{58}.[15:0]  | v1{59}.[15:0]  | v1{60}.[15:0]  | v1{61}.[15:0]  | v1{62}.[15:0]  | v1{63}.[15:0]  |
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
|        15 | v1{48}.[31:16] | v1{49}.[31:16] | v1{50}.[31:16] | v1{51}.[31:16] | v1{52}.[31:16] | v1{53}.[31:16] | v1{54}.[31:16] | v1{55}.[31:16] | v1{56}.[31:16] | v1{57}.[31:16] | v1{58}.[31:16] | v1{59}.[31:16] | v1{60}.[31:16] | v1{61}.[31:16] | v1{62}.[31:16] | v1{63}.[31:16] |
+-----------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+----------------+
```

```
Architecture: CDNA2
Instruction: V_MFMA_F32_16X16X16F16
Block 0
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|   D[M][N] | 0      | 1      | 2      | 3      | 4      | 5      | 6      | 7      | 8      | 9      | 10     | 11     | 12     | 13     | 14     | 15     |
+===========+========+========+========+========+========+========+========+========+========+========+========+========+========+========+========+========+
|         0 | v0{0}  | v0{1}  | v0{2}  | v0{3}  | v0{4}  | v0{5}  | v0{6}  | v0{7}  | v0{8}  | v0{9}  | v0{10} | v0{11} | v0{12} | v0{13} | v0{14} | v0{15} |
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|         1 | v1{0}  | v1{1}  | v1{2}  | v1{3}  | v1{4}  | v1{5}  | v1{6}  | v1{7}  | v1{8}  | v1{9}  | v1{10} | v1{11} | v1{12} | v1{13} | v1{14} | v1{15} |
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|         2 | v2{0}  | v2{1}  | v2{2}  | v2{3}  | v2{4}  | v2{5}  | v2{6}  | v2{7}  | v2{8}  | v2{9}  | v2{10} | v2{11} | v2{12} | v2{13} | v2{14} | v2{15} |
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|         3 | v3{0}  | v3{1}  | v3{2}  | v3{3}  | v3{4}  | v3{5}  | v3{6}  | v3{7}  | v3{8}  | v3{9}  | v3{10} | v3{11} | v3{12} | v3{13} | v3{14} | v3{15} |
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|         4 | v0{16} | v0{17} | v0{18} | v0{19} | v0{20} | v0{21} | v0{22} | v0{23} | v0{24} | v0{25} | v0{26} | v0{27} | v0{28} | v0{29} | v0{30} | v0{31} |
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|         5 | v1{16} | v1{17} | v1{18} | v1{19} | v1{20} | v1{21} | v1{22} | v1{23} | v1{24} | v1{25} | v1{26} | v1{27} | v1{28} | v1{29} | v1{30} | v1{31} |
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|         6 | v2{16} | v2{17} | v2{18} | v2{19} | v2{20} | v2{21} | v2{22} | v2{23} | v2{24} | v2{25} | v2{26} | v2{27} | v2{28} | v2{29} | v2{30} | v2{31} |
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|         7 | v3{16} | v3{17} | v3{18} | v3{19} | v3{20} | v3{21} | v3{22} | v3{23} | v3{24} | v3{25} | v3{26} | v3{27} | v3{28} | v3{29} | v3{30} | v3{31} |
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|         8 | v0{32} | v0{33} | v0{34} | v0{35} | v0{36} | v0{37} | v0{38} | v0{39} | v0{40} | v0{41} | v0{42} | v0{43} | v0{44} | v0{45} | v0{46} | v0{47} |
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|         9 | v1{32} | v1{33} | v1{34} | v1{35} | v1{36} | v1{37} | v1{38} | v1{39} | v1{40} | v1{41} | v1{42} | v1{43} | v1{44} | v1{45} | v1{46} | v1{47} |
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|        10 | v2{32} | v2{33} | v2{34} | v2{35} | v2{36} | v2{37} | v2{38} | v2{39} | v2{40} | v2{41} | v2{42} | v2{43} | v2{44} | v2{45} | v2{46} | v2{47} |
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|        11 | v3{32} | v3{33} | v3{34} | v3{35} | v3{36} | v3{37} | v3{38} | v3{39} | v3{40} | v3{41} | v3{42} | v3{43} | v3{44} | v3{45} | v3{46} | v3{47} |
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|        12 | v0{48} | v0{49} | v0{50} | v0{51} | v0{52} | v0{53} | v0{54} | v0{55} | v0{56} | v0{57} | v0{58} | v0{59} | v0{60} | v0{61} | v0{62} | v0{63} |
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|        13 | v1{48} | v1{49} | v1{50} | v1{51} | v1{52} | v1{53} | v1{54} | v1{55} | v1{56} | v1{57} | v1{58} | v1{59} | v1{60} | v1{61} | v1{62} | v1{63} |
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|        14 | v2{48} | v2{49} | v2{50} | v2{51} | v2{52} | v2{53} | v2{54} | v2{55} | v2{56} | v2{57} | v2{58} | v2{59} | v2{60} | v2{61} | v2{62} | v2{63} |
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
|        15 | v3{48} | v3{49} | v3{50} | v3{51} | v3{52} | v3{53} | v3{54} | v3{55} | v3{56} | v3{57} | v3{58} | v3{59} | v3{60} | v3{61} | v3{62} | v3{63} |
+-----------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+--------+
```
```
Architecture: CDNA2
Instruction: V_MFMA_F32_16X16X16F16
    Encoding: VOP3P-MAI
    VOP3P Opcode: 0x4d
    VOP3P-MAI Opcode: 0xd
    Matrix Dimensions:
        M: 16
        N: 16
        K: 16
        blocks: 1
    Execution statistics:
        FLOPs: 8192
        Execution cycles: 32
        FLOPs/CU/cycle: 1024
        Can co-execute with VALU: True
        VALU co-execution cycles possible: 28
    Register usage:
        GPRs required for A: 2
        GPRs required for B: 2
        GPRs required for C: 4
        GPRs required for D: 4
        GPR alignment requirement: 8 bytes
    VOP3P-MAI register encoding:
        A matrix source field: Src0
        B matrix source field: Src1
        C matrix source field: Src2
        D matrix source field: Vdst
    Register data types:
        Src0: FP16 (IEEE binary16 floating point)
        Src1: FP16 (IEEE binary16 floating point)
        Src2: FP32 (IEEE binary32 floating point)
        Vdst: FP32 (IEEE binary32 floating point)
    Register capabilities:
        A matrix can use ArchVGPRs: True
        A matrix can use AccVGPRs: True
        B matrix can use ArchVGPRs: True
        B matrix can use AccVGPRs: True
        C and D matrix can use ArchVGPRs: True
        C and D matrix can use AccVGPRs: True
    Register modifiers:
        CBSZ and ABID bits supported: False
        BLGP bits supported: True
    Matrix element to register mapping with no modifiers:
        A[i][k].block GPR: (floor(k / 2) % 2).[16*(k % 2)+15 : 16*(k % 2)]
        A[i][k].block Lane: 16 * floor(k / 4) + i
        B[k][j].block GPR: (floor(k / 2) % 2).[16*(k % 2)+15 : 16*(k % 2)]
        B[k][j].block Lane: 16 * floor(k / 4) + j
        C or D[i][j].block GPR: (i % 4)
        C or D[i][j].block Lane: 16 * floor(i / 4) + j
    Register to matrix element mapping with no modifiers:
        A i: (lane % 16)
        A k: 4 * floor(lane / 16) + 2 * GPR_num + floor(GPR_bits / 16)
        A block: 0
        B j: (lane % 16)
        B k: 4 * floor(lane / 16) + 2 * GPR_num + floor(GPR_bits / 16)
        B block: 0
        C or D i: 4 * floor(lane / 16) + (GPR_num % 4)
        C or D j: (lane % 16)
        C or D block: 0
```

### Omniperf

**Install**

```bash
tar xfz omniperf-v1.1.0-PR1.tar.gz
cd omniperf-v1.1.0-PR1
export INSTALL_DIR=~/omniperf

pip install -r requirements.txt
mkdir build
cd build
cmake -DCMAKE_INSTALL_PREFIX=${INSTALL_DIR}/1.1.0-PR1 \
        -DPYTHON_DEPS=${INSTALL_DIR}/python-libs \
        -DMOD_INSTALL_PATH=${INSTALL_DIR}/modulefiles ..

make install
```

**Profile**
```bash
omniperf profile -n vcopy_data -- ./vcopy
```
*It seems like profiling a python script does not work*


**Visualize**
```bash
omniperf analyze -p workloads/vcopy/mi200/ --gui
```

## ISA
[AMD_GCN](https://gpuopen.com/wp-content/uploads/2016/08/AMD_GCN3_Instruction_Set_Architecture_rev1.1.pdf)
[amdgcn-assembly](https://gpuopen.com/learn/amdgcn-assembly/)
```

                  cap gfx000 gfx803 gfx900 gfx906 gfx908 gfx90a gfx940 gfx941 gfx942 gfx1010 gfx1011 gfx1012 gfx1030 gfx1031 gfx1100 gfx1101 gfx1102 
      HasMFMA_bf16_1k      0      0      0      0      0      1      1      0      0       0       0       0       0       0       0       0       0 
       HasMFMA_i8_908      0      0      0      0      1      1      0      0      0       0       0       0       0       0       0       0       0 
       HasMFMA_i8_940      0      0      0      0      0      0      1      0      0       0       0       0       0       0       0       0       0 
           HasAddLshl      0      0      1      1      1      1      1      0      0       1       1       1       1       1       1       1       1 
         HasAtomicAdd      0      0      0      0      1      1      1      0      0       0       0       0       0       0       1       1       1 
   HasDirectToLdsDest      0      0      0      0      0      0      0      0      0       0       0       0       0       0       0       0       0 
 HasDirectToLdsNoDest      0      1      1      1      1      1      1      0      0       1       1       1       1       1       0       0       0 
        HasExplicitCO      0      0      1      1      1      1      1      0      0       1       1       1       1       1       1       1       1 
        HasExplicitNC      0      0      0      0      0      0      0      0      0       1       1       1       1       1       1       1       1 
       HasGLCModifier      0      1      1      1      1      1      0      0      0       1       1       1       1       1       1       1       1 
            HasLshlOr      0      0      1      1      1      1      1      0      0       1       1       1       1       1       1       1       1 
              HasMFMA      0      0      0      0      1      1      1      0      0       0       0       0       0       0       0       0       0 
            HasSMulHi      0      0      1      1      1      1      1      0      0       1       1       1       1       1       1       1       1 
              HasWMMA      0      0      0      0      0      0      0      0      0       0       0       0       0       0       1       1       1 
           MaxLgkmcnt      1      1      1      1      1      1      1      1      1       1       1       1       1       1       1       1       1 
             MaxVmcnt      0      1      1      1      1      1      1      0      0       1       1       1       1       1       1       1       1 
         SupportedISA      0      1      1      1      1      1      1      0      0       1       1       1       1       1       1       1       1 
      SupportedSource      1      1      1      1      1      1      1      1      1       1       1       1       1       1       1       1       1 
           HasMFMA_b8      0      0      0      0      0      0      1      0      0       0       0       0       0       0       0       0       0 
     HasMFMA_constSrc      0      0      0      0      0      1      1      0      0       0       0       0       0       0       0       0       0 
       v_dot2_f32_f16      0      0      0      1      1      1      1      0      0       0       1       1       1       1       1       1       1 
      v_dot2c_f32_f16      0      0      0      0      1      1      1      0      0       0       1       1       1       1       1       1       1 
            v_fma_f16      0      0      1      1      1      1      1      0      0       1       1       1       1       1       1       1       1 
           v_fmac_f16      0      0      0      0      0      0      0      0      0       0       0       0       0       0       0       0       0 
            v_mac_f16      0      1      1      1      1      1      1      0      0       0       0       0       0       0       0       0       0 
         v_pk_fma_f16      0      0      1      1      1      1      1      0      0       1       1       1       1       1       1       1       1 
        v_pk_fmac_f16      0      0      0      0      0      0      0      0      0       0       0       0       0       0       0       0       0 
            v_fma_f32      0      1      1      1      1      1      1      0      0       1       1       1       1       1       1       1       1 
        v_fma_mix_f32      0      0      0      1      1      1      1      0      0       1       1       1       1       1       1       1       1 
           v_fmac_f32      0      0      0      1      1      1      1      0      0       1       1       1       1       1       1       1       1 
            v_mac_f32      0      1      1      1      1      1      0      0      0       1       1       1       0       0       0       0       0 
        v_mad_mix_f32      0      0      1      0      0      0      0      0      0       0       0       0       0       0       0       0       0 
          HasMFMA_f64      0      0      0      0      0      1      1      0      0       0       0       0       0       0       0       0       0 
            v_fma_f64      0      1      1      1      1      1      1      0      0       1       1       1       1       1       1       1       1 
           HasMFMA_f8      0      0      0      0      0      0      1      0      0       0       0       0       0       0       0       0       0 
    VOP3v_dot4_i32_i8      0      0      0      1      1      1      1      0      0       0       1       1       1       1       0       0       0 
        v_dot4_i32_i8      0      0      0      0      0      0      0      0      0       0       0       0       0       0       0       0       0 
       v_dot4c_i32_i8      0      0      0      0      1      1      1      0      0       0       1       1       1       1       0       0       0 
HasMFMA_bf16_original      0      0      0      0      1      1      0      0      0       0       0       0       0       0       0       0       0 
         HasMFMA_vgpr      0      0      0      0      0      1      1      0      0       0       0       0       0       0       0       0       0 
         HasMFMA_xf32      0      0      0      0      0      0      1      0      0       0       0       0       0       0       0       0       0 
   ArchAccUnifiedRegs      0      0      0      0      0      1      1      1      1       0       0       0       0       0       0       0       0 
       CMPXWritesSGPR      1      1      1      1      1      1      1      1      1       0       0       0       0       0       0       0       0 
        CrosslaneWait      0      0      0      0      0      0      1      1      1       0       0       0       0       0       0       0       0 
        ForceStoreSC1      0      0      0      0      0      0      1      1      0       0       0       0       0       0       0       0       0 
             HasAccCD      0      0      0      0      0      1      1      1      1       0       0       0       0       0       0       0       0 
           HasEccHalf      0      0      0      1      1      1      1      1      1       0       0       0       0       0       0       0       0 
            HasWave32      0      0      0      0      0      0      0      0      0       1       1       1       1       1       1       1       1 
           InstRename      0      0      0      0      0      0      0      0      0       0       0       0       0       0       1       1       1 
        SeparateVscnt      0      0      0      0      0      0      0      0      0       1       1       1       1       1       1       1       1 
             VgprBank      0      0      0      0      0      0      0      0      0       1       1       1       1       1       1       1       1 
     Waitcnt0Disabled      0      0      0      0      1      1      1      1      1       0       0       0       0       0       0       0       0
```

[Inline Assembly Example](https://github.com/ROCm-Developer-Tools/HIP/tree/master/samples/2_Cookbook/10_inline_asm)
[Inline Assembly Kernel Example](https://github.com/ROCm-Developer-Tools/LLVM-AMDGPU-Assembler-Extra/blob/master/examples/gfx8/ds_bpermute.s)

```asm
 asm volatile ("v_mov_b32_e32 %0, %1" : "=v" (out[x*width + y]) : "v" (in[y*width + x]));
```

v refers to VGPR register
=v refers to assignment of this register

export KMDUMPLLVM=1 : This gets you LLVM IR.
export KMDUMPISA=1 : This gets you GCN ISA.

[Assembly Crosslane ops](https://gpuopen.com/learn/amd-gcn-assembly-cross-lane-operations/)
```asm
ds_permute_b32 dest, addr, src [offset:addr_offset] // push to dest
ds_bpermute_b32 dest, addr, src [offset:addr_offset] // pull from src
```

Haha apparently cuda equivalents are in `#include <hip/amd_detail/amd_warp_functions.h>`
So no need to write inline assembly to replicate cuda warp shuffles

### Interesting Instructions used in ROCBlas
[CDNA2 ISA Manual](https://www.amd.com/content/dam/amd/en/documents/instinct-tech-docs/instruction-set-architectures/instinct-mi200-cdna2-instruction-set-architecture.pdf)

```asm
/******************************************/
/* 2x2 thread-tile                        */
/******************************************/
.macro MAC_2x2_X0
// Component.MAC.MAC_I8X4_Plain
v_dot4_i32_i8 v[vgprValuC+0+0*2], v[vgprValuA_X0_I0+0], v[vgprValuB_X0_I0+0], v[vgprValuC+0+0*2] op_sel:[0,0] op_sel_hi:[1,1] //valuC[0]
s_setprio 1 // Raise priority while processing macs
v_dot4_i32_i8 v[vgprValuC+1+0*2], v[vgprValuA_X0_I0+1], v[vgprValuB_X0_I0+0], v[vgprValuC+1+0*2] op_sel:[0,0] op_sel_hi:[1,1] //valuC[1]
v_dot4_i32_i8 v[vgprValuC+0+1*2], v[vgprValuA_X0_I0+0], v[vgprValuB_X0_I0+1], v[vgprValuC+0+1*2] op_sel:[0,0] op_sel_hi:[1,1] //valuC[2]
v_dot4_i32_i8 v[vgprValuC+1+1*2], v[vgprValuA_X0_I0+1], v[vgprValuB_X0_I0+1], v[vgprValuC+1+1*2] op_sel:[0,0] op_sel_hi:[1,1] //valuC[3]
s_setprio 0 // Reset priority after macs
.endm
.macro MAC_2x2_X1
// Component.MAC.MAC_I8X4_Plain
v_dot4_i32_i8 v[vgprValuC+0+0*2], v[vgprValuA_X1_I0+0], v[vgprValuB_X1_I0+0], v[vgprValuC+0+0*2] op_sel:[0,0] op_sel_hi:[1,1] //valuC[0]
s_setprio 1 // Raise priority while processing macs
v_dot4_i32_i8 v[vgprValuC+1+0*2], v[vgprValuA_X1_I0+1], v[vgprValuB_X1_I0+0], v[vgprValuC+1+0*2] op_sel:[0,0] op_sel_hi:[1,1] //valuC[1]
v_dot4_i32_i8 v[vgprValuC+0+1*2], v[vgprValuA_X1_I0+0], v[vgprValuB_X1_I0+1], v[vgprValuC+0+1*2] op_sel:[0,0] op_sel_hi:[1,1] //valuC[2]
v_dot4_i32_i8 v[vgprValuC+1+1*2], v[vgprValuA_X1_I0+1], v[vgprValuB_X1_I0+1], v[vgprValuC+1+1*2] op_sel:[0,0] op_sel_hi:[1,1] //valuC[3]
s_setprio 0 // Reset priority after macs
.endm
```

> v_dot4_i32_i8
```
D.i32 = S0.i8[0] * S1.i8[0] + S0.i8[1] * S1.i8[1] + S0.i8[2] *
S1.i8[2] + S0.i8[3] * S1.i8[3] + S2.i32
```

Cijk_Ailk_Bljk_SB_MT64x32x32_MI16x16x4x1_SE_1LDSB0_APM1_ABV0_ACED0_AF0EM1_AF1EM1_AMAS0_ASE_ASGT_ASLT_ASAE01_ASCE01_ASEM1_AAC0_BL1_BS1_DTL0_DTVA0_DVO0_ETSP_EPS0_FL0_GRPM1_GRVW4_GSU1_GSUASB_GLS0_ISA90a_IU1_K1_KLA_LBSPP128_LPA0_LPB4_LDL1_LRVW2_LWPMn1_LDW0_MAC_MIAV0_MDA2_MO40_NTA0_NTB0_NTC0_NTD0_NEPBS0_NLCA1_NLCB1_ONLL1_OPLV0_PK0_PAP0_PGR2_PLR9_RK0_SIA3_SS0_SU32_SUM0_SUS256_SCIUI1_SPO0_SRVW2_SSO0_SVW4_SNLL0_TT2_16_TLDS1_USFGROn1_VAW1_VSn1_VW1_WSGRA1_WSGRB1_WS64_WG32_8_1_WGM2.kd


## MISC
**Torch HIP Semantics**
https://pytorch.org/docs/stable/notes/hip.html

[mix-bench](https://github.com/ekondis/mixbench)
[HIP](https://github.com/ROCm-Developer-Tools/HIP)
